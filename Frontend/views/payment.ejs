<%- include('includes/head') %>
    <link rel="stylesheet" href="/styles/payment.css">
    </head>

    <body>
        <%- include('includes/nav') %>

            <main class="payment-container">
                <section class="payment-card">
                    <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤</h2>

                    <div class="items-list">
                        <% cartItems.forEach(item=> { %>
                            <div class="item">
                                <span>
                                    <%= item.product.product_name %>
                                </span>
                                <span>
                                    <%= item.numericPrice || item.product.price %> ‡∏ö‡∏≤‡∏ó
                                </span>
                            </div>
                            <% }) %>
                    </div>

                    <div class="total-box">
                        <p><strong>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</strong></p>

                        <div class="price-line">
                            <span>üí∏ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏ß‡∏°</span>
                            <span>
                                <%= totalRent.toFixed(2) %> ‡∏ö‡∏≤‡∏ó
                            </span>
                        </div>

                        <div class="price-line">
                            <span>üîí ‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                            <span>
                                <%= totalDeposit.toFixed(2) %> ‡∏ö‡∏≤‡∏ó
                            </span>
                        </div>

                        <hr>

                        <div class="price-line total">
                            <span><strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞)</strong></span>
                            <span><strong>
                                    <%= total.toFixed(2) %> ‡∏ö‡∏≤‡∏ó
                                </strong></span>
                        </div>

                        <small style="color:#666;">*‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏°‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</small>
                    </div>


                    <hr class="divider">

                    <h2 style=" font-size: 34px; ">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</h2>

                    <div class="qr-box">
                        <img id="qrImage" alt="PromptPay QR">
                    </div>

                    <p class="note">‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô</p>
                </section>

                <!-- ‚úÖ ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ -->
                <form id="slipForm" enctype="multipart/form-data" class="slip-form">
                    <label for="slip">üìé ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</label>
                    <input type="file" id="slip" name="slip" accept="image/*" required>
                    <div id="preview-container" class="preview-container"></div>

                    <button type="submit" id="confirmBtn" class="btn-confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
                </form>

                <!-- ‚úÖ ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -->
                <div id="successBox" class="success-box" style="display:none;">
                    <h2>‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
                    <p>‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</p>
                    <a href="/my_rentals" class="btn-goto">‡∏î‡∏π‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ä‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
                </div>
            </main>

            <%- include('includes/footer') %>

                <script>
                    const orderId = <%- JSON.stringify(orderId) %>;
                    const total = <%- JSON.stringify(total) %>;

                    async function loadQR() {
                        const res = await fetch('/api/payment/generate-qr', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ amount: total })
                        });
                        const data = await res.json();
                        if (data.qrImage) {
                            document.getElementById('qrImage').src = data.qrImage;
                        }
                    }
                    loadQR();

                    // ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                    document.getElementById("slipForm").addEventListener("submit", async e => {
                        e.preventDefault();
                        const fileInput = document.getElementById("slip");
                        const confirmBtn = document.getElementById("confirmBtn");

                        if (!fileInput.files.length) {
                            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô");
                            return;
                        }

                        confirmBtn.disabled = true;
                        confirmBtn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";

                        try {
                            const formData = new FormData();
                            formData.append("slip", fileInput.files[0]);
                            formData.append("orderId", orderId);
                            console.log("üßæ formData", [...formData.entries()]);

                            const res = await fetch("/api/orders/upload-slip", {
                                method: "POST",
                                body: formData,
                            });

                            const text = await res.text(); // ‡∏≠‡πà‡∏≤‡∏ô body ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                            let data;
                            try {
                                data = JSON.parse(text);
                            } catch {
                                throw new Error("Response ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON: " + text.slice(0, 100));
                            }

                            if (!res.ok) throw new Error(data.message || "Upload failed");

                            console.log("‚úÖ Upload success:", data);
                            alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

                            // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                            document.getElementById("slipForm").style.display = "none";
                            document.getElementById("successBox").style.display = "block";

                        } catch (err) {
                            console.error("‚ùå Upload error:", err);
                            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
                            confirmBtn.disabled = false;
                            confirmBtn.textContent = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô";
                        }
                    });


                    // ‚úÖ ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                    const input = document.getElementById("slip");
                    const previewContainer = document.getElementById("preview-container");

                    if (input && previewContainer) {
                        input.addEventListener("change", () => {
                            previewContainer.innerHTML = "";
                            Array.from(input.files).forEach((file, index) => {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    const div = document.createElement("div");
                                    div.classList.add("preview-item");
                                    div.innerHTML = `
              <img src="${e.target.result}" alt="preview-${index}">
              <button type="button" data-index="${index}">‚úï</button>
            `;
                                    div.querySelector("button").addEventListener("click", () => {
                                        removeFile(index);
                                        div.remove();
                                    });
                                    previewContainer.appendChild(div);
                                };
                                reader.readAsDataURL(file);
                            });
                        });

                        function removeFile(removeIndex) {
                            const dt = new DataTransfer();
                            Array.from(input.files).forEach((file, idx) => {
                                if (idx !== removeIndex) dt.items.add(file);
                            });
                            input.files = dt.files;
                        }
                    }
                </script>
    </body>

    </html>