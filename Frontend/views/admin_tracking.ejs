<%- include('includes/head') %>
  <link rel="stylesheet" href="/styles/admin.css">

  </head>

  <body>
    <%- include('includes/navAdmin') %>

      <main class="section-p1">
        <h2>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h2>

        <!-- ‚úÖ ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏ -->
        <div class="shipping-form-card">
          <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
          <form id="shippingForm" enctype="multipart/form-data">
            <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏:</label>
            <input type="text" name="tracking_code" placeholder="‡πÄ‡∏ä‡πà‡∏ô EX123456789TH" required>

            <label>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏ö‡∏¥‡∏• / ‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏:</label>
            <input type="file" name="image_slip" accept="image/*" required>

            <button type="submit" class="btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</button>
          </form>
        </div>

        <% if (typeof pending !=="undefined" && Array.isArray(pending) && pending.length> 0) { %>
          <div class="table-container">
            <table class="rental-table">
              <thead>
                <tr>
                  <th>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</th>
                  <th>‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                  <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                  <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤</th>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</th>
                </tr>
              </thead>
              <tbody>
                <% pending.forEach(r=> { %>
                  <tr>
                    <td>
                      <% // üîç ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ orderItem ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö productId ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ const
                        matchedOrderItem=r.order?.OrderItem?.find(i=> i.productId === r.product.product_id);
                        %>
                        <input type="checkbox" name="selectItem" value="<%= matchedOrderItem?.orderItem_id || '' %>"
                          data-shipping="<%= r.order?.shippings?.[0]?.shipping_id || '' %>">
                    </td>

                    <td><img src="<%= r.product.images?.[0]?.image_url || '/images/no-image.png' %>" width="80"></td>
                    <td>
                      <%= r.product.product_name %>
                    </td>
                    <td>
                      <%= r.customer.name %>
                        <%= r.customer.last_name %>
                    </td>
                    <td>
                      <%= new Date(r.rental_date).toLocaleDateString() %>
                    </td>
                    <td>
                      <%= new Date(r.rental_end_date).toLocaleDateString() %>
                    </td>
                  </tr>
                  <% }) %>
              </tbody>

            </table>
          </div>
          <% } else { %>
            <p style="text-align:center; font-size:18px; color:#718096;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</p>
            <% } %>
      </main>

      <script src="/js/script.js"></script>

      <script>
        document.getElementById("shippingForm").addEventListener("submit", async (e) => {
          e.preventDefault();

          const selected = [...document.querySelectorAll("input[name='selectItem']:checked")];
          if (selected.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á");

          const form = e.target;
          const formData = new FormData(form);

          // ‚úÖ ‡∏î‡∏∂‡∏á shippingId ‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å (‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô order ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
          const shippingId = selected[0].dataset.shipping;
          if (!shippingId) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö Shipping ID");

          // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö orderItemIds ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          const orderItemIds = selected.map(cb => cb.value);
          formData.append("shippingId", shippingId);
          formData.append("orderItemIds", JSON.stringify(orderItemIds));
          formData.append("note", "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");

          const res = await fetch("/api/shipping/addBox", {
            method: "POST",
            body: formData
          });

          const data = await res.json();
          alert(data.message || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          if (res.ok) window.location.reload();
        });

      </script>
  </body>

  </html>