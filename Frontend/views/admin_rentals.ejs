<%- include('includes/head') %>
  <link rel="stylesheet" href="/styles/admin.css">
  </head>

  <body>
    <%- include('includes/navAdmin') %>

      <main class="section-p1">
        <h2>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ä‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h2>

        <div class="table-container">
          <table class="rental-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th>‡∏£‡∏´‡∏±‡∏™</th>
                <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
                <th>‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</th>
                <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πà‡∏≤</th>
                <th>‡∏ß‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>‡∏™‡∏•‡∏µ‡∏õ</th>
              </tr>
            </thead>
            <tbody id="rentalBody"></tbody>
          </table>
        </div>

        <div class="actions">
          <button id="confirmSelectedBtn" class="btn-confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
          <button id="rejectSelectedBtn" class="btn-cancel">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
        </div>
      </main>

      <!-- üîπ Modal Popup -->
      <div id="rejectModal" class="modal hidden">
        <div class="modal-content">
          <h3>‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
          <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ:</p>

          <select id="rejectReason">
            <option value="">-- ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• --</option>
            <option value="‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
            <option value="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</option>
            <option value="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠</option>
            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏...</option>
          </select>

          <textarea id="rejectDetail" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..." rows="3"></textarea>

          <div class="modal-actions">
            <button id="confirmRejectBtn" class="btn-cancel">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            <button id="cancelRejectBtn" class="btn-save">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </div>
      </div>


      <script>
        document.addEventListener("DOMContentLoaded", async () => {
          const res = await fetch("/api/rentals");
          const rentals = await res.json();
          const tbody = document.getElementById("rentalBody");
          console.log("üì¶ rentals data:", rentals);

          rentals
            .filter(r => r.rental_status === "WAITING_CONFIRM")
            .forEach(r => {
              // ‚úÖ ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ
              const slipLink = r.PaymentSlip?.length
                ? `<a href="${r.PaymentSlip[0].image_url}" target="_blank" class="slip-link">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a>`
                : `<span class="no-slip">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏•‡∏¥‡∏õ</span>`;

              // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
              const addressInfo = r.customer
                ? `
                  <div class="address-block">
                    <div>${r.customer.address || ''}</div>
                    <div>${r.customer.sub_district || ''} ${r.customer.district || ''}</div>
                    <div>${r.customer.province || ''} ${r.customer.postal_code || ''}</div>
                  </div>
                `
                : "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";

              // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (thumbnail)
              const idCard = r.customer?.id_card_image_url
                ? `<a href="${r.customer.id_card_image_url}" target="_blank">
                    <img src="${r.customer.id_card_image_url}" class="idcard-thumb" alt="‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä.">
                  </a>`
                : `<span class="no-idcard">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</span>`;

              // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td><input type="checkbox" name="selected" value="${r.rental_id}"></td>
                <td>${r.rental_id}</td>
                <td>${r.customer ? `${r.customer.name} ${r.customer.last_name}` : "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}</td>
                <td>${addressInfo}</td>
                <td>${idCard}</td>
                <td>${r.product?.product_name || "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"}</td>
                <td>${new Date(r.rental_date).toLocaleDateString()}</td>
                <td>${new Date(r.rental_end_date).toLocaleDateString()}</td>
                <td><span class="status-tag waiting">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span></td>
                <td>${slipLink}</td>
              `;
              tbody.appendChild(tr);
            });

          // ‚úÖ ‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          const selectAll = document.getElementById("selectAll");
          selectAll?.addEventListener("change", e => {
            document.querySelectorAll("input[name=selected]").forEach(chk => {
              chk.checked = e.target.checked;
            });
          });

          // ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
          document.getElementById("confirmSelectedBtn").addEventListener("click", async () => {
            const selected = Array.from(document.querySelectorAll("input[name=selected]:checked"))
              .map(chk => parseInt(chk.value));

            if (!selected.length) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô");

            try {
              const res = await fetch("/api/rentals/confirm-batch", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ rentalIds: selected })
              });

              const data = await res.json();
              if (!res.ok) throw new Error(data.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
              alert(data.message);
              location.reload();
            } catch (err) {
              console.error("‚ùå fetch error:", err);
              alert(err.message);
            }
          });
        });

        // ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
        const rejectBtn = document.getElementById("rejectSelectedBtn");
        const modal = document.getElementById("rejectModal");
        const confirmRejectBtn = document.getElementById("confirmRejectBtn");
        const cancelRejectBtn = document.getElementById("cancelRejectBtn");

        rejectBtn.addEventListener("click", () => {
          const selected = Array.from(document.querySelectorAll("input[name=selected]:checked"))
            .map(chk => parseInt(chk.value));

          if (!selected.length) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò");

          modal.classList.remove("hidden");
          confirmRejectBtn.dataset.ids = JSON.stringify(selected);
        });

        cancelRejectBtn.addEventListener("click", () => modal.classList.add("hidden"));

        confirmRejectBtn.addEventListener("click", async () => {
          const ids = JSON.parse(confirmRejectBtn.dataset.ids || "[]");
          const reason = document.getElementById("rejectReason").value;
          const detail = document.getElementById("rejectDetail").value;

          if (!reason) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•");

          try {
            const res = await fetch("/api/rentals/reject", {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ rentalIds: ids, reason, detail }),
            });
            const data = await res.json();
            alert(data.message || "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            location.reload();
          } catch (err) {
            console.error("‚ùå reject error:", err);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
          }
        });

      </script>

  </body>

  </html>