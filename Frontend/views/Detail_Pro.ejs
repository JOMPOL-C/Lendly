<%- include('includes/head') %>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="stylesheet" href="/styles/review.css">
  </head>

  <body>
    <%- include('includes/nav') %>
      <main>
        <section id="prodetails" class="section-p1">
          <div class="single-pro-image">
            <% if (product.images && product.images.length> 0) { %>
              <img src="<%= product.images[0].image_url %>" width="100%" id="MainImg" alt="<%= product.product_name %>">
              <% } else { %>
                <img src="/images/no-image.png" width="100%" id="MainImg" alt="no image">
                <% } %>

                  <div class="small-img-group">
                    <% if (product.images && product.images.length> 1) { %>
                      <% product.images.forEach((img, index)=> { %>
                        <div class="small-img-col">
                          <img src="<%= img.image_url %>" width="100%" class="small-img" alt="image <%= index %>">
                        </div>
                        <% }) %>
                          <% } %>
                  </div>
          </div>

          <div class="single-pro-details">
            <h6>
              <%= product.category ? product.category.category_name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' %>
            </h6>
            <h4>
              <%= product.product_name %>
            </h4>

            <h2 id="priceDisplay">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô</h2>

            <!-- ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ä‡πà‡∏≤ -->
            <% const firstPrice=product.prices && product.prices.length> 0 ? product.prices[0] : null;
              %>

              <label>
                <input type="radio" name="mode" value="test" checked>
                ‡πÄ‡∏ó‡∏™ (<%= firstPrice?.days_test || 2 %> ‡∏ß‡∏±‡∏ô)
              </label>
              <label>
                <input type="radio" name="mode" value="pri">
                ‡πÑ‡∏û‡∏£ (<%= firstPrice?.days_pri || 3 %> ‡∏ß‡∏±‡∏ô)
              </label>


              <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤ -->
              <select name="components" id="">
                <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤</option>
                <option value="suit">‡∏ä‡∏∏‡∏î</option>
                <option value="wig">‡∏ß‡∏¥‡∏Å</option>
                <option value="set-wig">‡∏ä‡∏∏‡∏î + ‡∏ß‡∏¥‡∏Å</option>
                <option value="set-wig-prop">‡∏ä‡∏∏‡∏î + ‡∏ß‡∏¥‡∏Å + ‡∏û‡∏£‡πá‡∏≠‡∏û</option>
                <option value="set-wig-shoe">‡∏ä‡∏∏‡∏î + ‡∏ß‡∏¥‡∏Å + ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤</option>
                <option value="set-wig-prop-shoe">‡∏ä‡∏∏‡∏î + ‡∏ß‡∏¥‡∏Å + ‡∏û‡∏£‡πá‡∏≠‡∏û + ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤</option>
                <option value="prop">‡∏û‡∏£‡πá‡∏≠‡∏û‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option>
                <option value="shoe">‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option>
              </select>

              <!-- ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô -->
              <div id="calendar" data-product-id="<%= product.product_id %>"></div>

              <button id="addToCartBtn" class="btn-cart">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
          </div>
        </section>
      </main>

      <%- include('includes/footer') %>
        <script src="/js/script.js"></script>
        <script src="/js/booking.js"></script>

        <script>
          // ‚úÖ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          const productPrices = <%- JSON.stringify(product.prices || []) %>;
          console.log("üí∞ productPrices:", productPrices);

          const priceDisplay = document.getElementById("priceDisplay");
          const componentSelect = document.querySelector("select[name=components]");
          const modeRadios = document.querySelectorAll("input[name=mode]");

          // ‚úÖ Mapping: ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‚Üí type ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
          const mapping = {
            "suit": "suit",
            "wig": "wig",
            "set-wig": "suit_wig",
            "set-wig-prop": "suit_wig_prop",
            "set-wig-shoe": "suit_wig_shoe",
            "set-wig-prop-shoe": "suit_wig_prop_shoe",
            "prop": "solo_prop",
            "shoe": "solo_shoe"
          };

          // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö productPriceId ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
          let selectedPriceId = null;

          // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤
          function updatePrice() {
            const selectedMode = document.querySelector("input[name=mode]:checked")?.value;
            const selectedComponent = componentSelect?.value;

            if (!selectedMode || !selectedComponent) {
              priceDisplay.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô";
              selectedPriceId = null;
              return;
            }

            const dbType = mapping[selectedComponent];
            const priceObj = productPrices.find(p => p.type === dbType);

            if (!priceObj) {
              priceDisplay.textContent = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö";
              selectedPriceId = null;
              return;
            }

            selectedPriceId = priceObj.productPrice_id; // üëà ‡πÄ‡∏Å‡πá‡∏ö id ‡∏à‡∏£‡∏¥‡∏á
            const price = selectedMode === "test" ? priceObj.price_test : priceObj.price_pri;

            // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const rentalDays =
              selectedMode === "test"
                ? (priceObj.days_test || 1)
                : (priceObj.days_pri || 1);

            const label = selectedMode === "test"
              ? `‡πÄ‡∏ó‡∏™ (${rentalDays} ‡∏ß‡∏±‡∏ô)`
              : `‡πÑ‡∏û‡∏£ (${rentalDays} ‡∏ß‡∏±‡∏ô)`;

            priceDisplay.textContent = `‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ä‡πà‡∏≤: ${price} ‡∏ö‡∏≤‡∏ó (${label})`;

          }

          componentSelect.addEventListener("change", updatePrice);
          modeRadios.forEach(r => r.addEventListener("change", updatePrice));

          // ‚úÖ ‡∏™‡∏•‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å
          const MainImg = document.getElementById("MainImg");
          const smallimg = document.getElementsByClassName("small-img");
          for (let i = 0; i < smallimg.length; i++) {
            smallimg[i].onclick = function () {
              MainImg.src = smallimg[i].src;
            };
          }

          // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
          document.getElementById("addToCartBtn").addEventListener("click", async () => {
            const mode = document.querySelector("input[name=mode]:checked")?.value;
            const component = document.querySelector("select[name=components]")?.value;
            const range = document.querySelector("#calendar")._flatpickr.selectedDates;

            if (!mode) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î ‡πÄ‡∏ó‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏û‡∏£");
            if (!component) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤");
            if (!range || range.length < 2) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            if (!selectedPriceId) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô");

            function fixDate(d) {
              const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
              return local.toISOString().split("T")[0];
            }

            const start = fixDate(range[0]);
            const end = fixDate(range[1]);


            const productId = "<%= product.product_id %>";

            const res = await fetch("/api/cart/add", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                productId,
                productPriceId: selectedPriceId,
                mode,
                start,
                end,  // ‚úÖ ‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°-‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏õ‡∏Å‡∏±‡∏ö body
              }),
            });

            const data = await res.json();
            if (res.ok) {
              alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
              window.location.href = "/cart";
            } else {
              alert(data.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ");
            }
          });
        </script>
  </body>

  </html>