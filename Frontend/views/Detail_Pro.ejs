<%- include('includes/head') %>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">

  <link rel="stylesheet" href="/styles/review.css">
  </head>

  <body>
    <%- include('includes/nav') %>
      <main>
        <section id="prodetails" class="section-p1">
          <div class="single-pro-image">
            <% if (product.images && product.images.length> 0) { %>
              <img src="<%= product.images[0].image_url %>" width="100%" id="MainImg" alt="<%= product.product_name %>">
              <% } else { %>
                <img src="/images/no-image.png" width="100%" id="MainImg" alt="no image">
                <% } %>

                  <div class="small-img-group">
                    <% if (product.images && product.images.length> 1) { %>
                      <% product.images.forEach((img, index)=> { %>
                        <div class="small-img-col">
                          <img src="<%= img.image_url %>" width="100%" class="small-img" alt="image <%= index %>">
                        </div>
                        <% }) %>
                          <% } %>
                  </div>
          </div>

          <div class="single-pro-details">
            <h6>
              <%= product.category ? product.category.category_name : 'ไม่ระบุหมวดหมู่' %>
            </h6>
            <h4>
              <%= product.product_name %>
            </h4>

            <h2 id="priceDisplay">กรุณาเลือกของเช่าและโหมดก่อน</h2>

            <!-- โหมดเช่า -->
            <label><input type="radio" name="mode" value="test" checked> เทส (2 วัน)</label>
            <label><input type="radio" name="mode" value="pri"> ไพร (3 วัน)</label>

            <!-- ตัวเลือกการเช่า -->
            <select name="components" id="">
              <option value="" disabled selected>เลือกของเช่า</option>
              <option value="suit">ชุด</option>
              <option value="wig">วิก</option>
              <option value="set-wig">ชุด + วิก</option>
              <option value="set-wig-prop">ชุด + วิก + พร็อพ</option>
              <option value="set-wig-shoe">ชุด + วิก + รองเท้า</option>
              <option value="set-wig-prop-shoe">ชุด + วิก + พร็อพ + รองเท้า</option>
              <option value="prop">พร็อพเดี่ยว</option>
              <option value="shoe">รองเท้าเดี่ยว</option>
            </select>

            <div id="calendar"></div>
            <button id="addToCartBtn" class="btn-cart">เพิ่มลงตะกร้า</button>
          </div>
        </section>
      </main>

      <%- include('includes/footer') %>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script src="/js/script.js"></script>
        <script src="/js/booking.js"></script>

        <script>
          // ✅ ราคาจากฐานข้อมูล (ฝั่งเซิร์ฟเวอร์)
          const productPrices = <%- JSON.stringify(product.prices || []) %>;

          const priceDisplay = document.getElementById("priceDisplay");
          const componentSelect = document.querySelector("select[name=components]");
          const modeRadios = document.querySelectorAll("input[name=mode]");

          // ✅ Mapping: ตัวเลือกหน้าเว็บ → type ในฐานข้อมูลจริง
          const mapping = {
            "suit": "suit",
            "wig": "wig",
            "set-wig": "suit_wig",
            "set-wig-prop": "suit_wig_prop",
            "set-wig-shoe": "suit_wig_shoe",
            "set-wig-prop-shoe": "suit_wig_prop_shoe",
            "prop": "solo_prop",
            "shoe": "solo_shoe"
          };

          // ✅ อัปเดตราคาเมื่อเลือกโหมดหรือของเช่า
          function updatePrice() {
            const selectedMode = document.querySelector("input[name=mode]:checked")?.value;
            const selectedComponent = componentSelect?.value;

            if (!selectedMode || !selectedComponent) {
              priceDisplay.textContent = "กรุณาเลือกของเช่าและโหมดก่อน";
              return;
            }

            const dbType = mapping[selectedComponent];
            const priceObj = productPrices.find(p => p.type === dbType);

            if (!priceObj) {
              priceDisplay.textContent = "ไม่มีราคาสำหรับตัวเลือกนี้ในระบบ";
              return;
            }

            const price = selectedMode === "test" ? priceObj.price_test : priceObj.price_pri;
            const label = selectedMode === "test" ? "เทส (2 วัน)" : "ไพร (3 วัน)";
            priceDisplay.textContent = `ราคาเช่า: ${price} บาท (${label})`;
          }

          componentSelect.addEventListener("change", updatePrice);
          modeRadios.forEach(r => r.addEventListener("change", updatePrice));
        </script>

        <script>
          // สลับภาพหลัก
          const MainImg = document.getElementById("MainImg");
          const smallimg = document.getElementsByClassName("small-img");
          for (let i = 0; i < smallimg.length; i++) {
            smallimg[i].onclick = function () {
              MainImg.src = smallimg[i].src;
            };
          }

          // เพิ่มลงตะกร้า
          document.getElementById("addToCartBtn").addEventListener("click", async () => {
            const mode = document.querySelector("input[name=mode]:checked")?.value;
            const component = document.querySelector("select[name=components]")?.value;
            const range = document.querySelector("#calendar")._flatpickr.selectedDates;

            if (!mode) return alert("กรุณาเลือกโหมด เทส หรือ ไพร");
            if (!component) return alert("กรุณาเลือกของเช่า");
            if (!range || range.length < 2) return alert("กรุณาเลือกวันที่เช่าให้ครบ");

            const start = range[0].toISOString().split("T")[0];
            const end = range[1].toISOString().split("T")[0];

            const productId = "<%= product.product_id %>";

            const res = await fetch("/api/cart/add", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ productId, mode, component, start, end })
            });

            const data = await res.json();
            if (res.ok) {
              alert("เพิ่มสินค้าลงตะกร้าเรียบร้อยแล้ว!");
              window.location.href = "/cart";
            } else {
              alert(data.message || "ไม่สามารถเพิ่มสินค้าได้");
            }
          });
        </script>
  </body>

  </html>