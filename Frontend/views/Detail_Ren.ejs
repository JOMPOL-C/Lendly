<%- include('includes/head') %>
    <link rel="stylesheet" href="/styles/rental.css">
    <link rel="stylesheet" href="/styles/detailRen.css">
    <style>
        .popup {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .popup-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
            text-align: left;
        }

        .popup-content h3 {
            text-align: center;
            margin-bottom: 15px;
        }

        .popup-content label {
            display: block;
            margin-top: 10px;
            font-weight: 600;
        }

        .popup-content input[type="text"],
        .popup-content input[type="file"] {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ddd;
            margin-top: 5px;
        }

        .item-list {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 5px;
        }

        .item-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .item-option img {
            border-radius: 5px;
            border: 1px solid #eee;
        }

        .popup-actions {
            text-align: center;
            margin-top: 15px;
        }
    </style>
    </head>

    <body>
        <%- include('includes/nav') %>

            <main>
                <section class="index">
                    <h2>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤</h2>

                    <!-- ‚úÖ Timeline ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
                    <div class="timeline-horizontal">
                        <div class="step">
                            <div class="circle">1</div>
                            <p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="circle">2</div>
                            <p>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á</p>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="circle">3</div>
                            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</p>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="circle">4</div>
                            <p>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="circle">5</div>
                            <p>‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</p>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="circle">6</div>
                            <p>‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô)</p>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="circle">7</div>
                            <p>‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>
                        </div>
                    </div>

                    <p id="tracking-label" class="tracking-note">üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p>

                    <!-- ‚úÖ ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ -->
                    <div class="order-summary">
                        <h3>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: <%= order.order_code %>
                        </h3>
                        <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á: <%= new Date(order.created_at).toLocaleDateString("th-TH") %>
                        </p>
                    </div>

                    <!-- ‚úÖ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ -->
                    <% var activeRentals=order.Rentals.filter(r=>
                        ["WAITING_CONFIRM","WAITING_DELIVER","WAITING_RECEIVE","RENTED","RETURNING","RETURNED"].includes(r.rental_status)
                        ); %>


                        <% if (activeRentals.length===0) { %>
                            <p style="text-align:center; color:#777;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤</p>
                            <% } else { %>
                                <% activeRentals.forEach(r=> { %>
                                    <article class="rental-card item-card" data-rental="<%= r.rental_id %>">
                                        <img src="<%= r.product?.images?.[0]?.image_url || '/images/no-image.png' %>"
                                            alt="" class="thumb">

                                        <div class="meta">
                                            <h4>
                                                <%= r.product?.product_name %>
                                            </h4>
                                            <p>
                                                ‡πÄ‡∏ä‡πà‡∏≤: <%= new Date(r.rental_date).toLocaleDateString('th-TH') %> ‚Ä¢
                                                    ‡∏Ñ‡∏∑‡∏ô: <%= new Date(r.rental_end_date).toLocaleDateString('th-TH') %>
                                            </p>

                                            <p class="status <%= r.rental_status.toLowerCase().replace('_','-') %>">
                                                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:
                                                <% if (r.rental_status==="WAITING_CONFIRM" ) { %>
                                                    ‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô
                                                    <% } else if (r.rental_status==="WAITING_DELIVER" ) { %>
                                                        ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á
                                                        <% } else if (r.rental_status==="WAITING_RECEIVE" ) { %>
                                                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
                                                            <% } else if (r.rental_status==="RENTED" ) { %>
                                                                ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                                                                <% } else if (r.rental_status==="RETURNING" ) { %>
                                                                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                                                                    <% } else if (r.rental_status==="RETURNED" ) { %>
                                                                        ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                                                                        <% } %>
                                            </p>

                                            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
                                            <% if (r.rental_status==="WAITING_RECEIVE" ) { %>
                                                <button class="btn-receive gray" data-rental="<%= r.rental_id %>">
                                                    üì¶ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                                                </button>
                                                <% } else if (r.rental_status==="RENTED" ) { %>
                                                    <button class="btn-return gray" data-order="<%= order.order_id %>">
                                                        üì¶ ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                                                    </button>
                                                    <% } else { %>
                                                        <button class="btn-gray" disabled>
                                                            üì¶ ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                                                        </button>
                                                        <% } %>


                                                            <% var boxes=order.shippings.flatMap(s=> s.boxes)
                                                                .filter(b => b.items?.some(it =>
                                                                it.orderItem?.product?.product_id ===
                                                                r.product.product_id
                                                                &&
                                                                (!r.orderItemId || it.orderItemId === r.orderItemId)
                                                                ));

                                                                var trackingCodes = boxes.map(b =>
                                                                b.tracking_code).filter(Boolean);
                                                                var canShowTracking = ["WAITING_RECEIVE", "RENTED",
                                                                "RETURNING", "RETURNED"].includes(r.rental_status);
                                                                %>



                                                                <div class="tracking-section">
                                                                    <% if (r.rental_status==="RETURNING" ||
                                                                        r.rental_status==="RETURNED" ) { %>
                                                                        <% if (r.return_tracking_code) { %>
                                                                            <div class="tracking-box">
                                                                                <p class="tracking-title">üì¶
                                                                                    ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</p>
                                                                                <a href="https://track.thailandpost.co.th/?trackNumber=<%= r.return_tracking_code %>"
                                                                                    target="_blank"
                                                                                    class="tracking-link">
                                                                                    <%= r.return_tracking_code %>
                                                                                </a>
                                                                                <button type="button" class="btn-track"
                                                                                    data-tracking="<%= r.return_tracking_code %>">
                                                                                    ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô
                                                                                </button>
                                                                                <div class="shipping-detail"
                                                                                    style="display:none;"></div>
                                                                            </div>
                                                                            <% } else { %>
                                                                                <p style="color:#888;">
                                                                                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                                                                                <% } %>
                                                                                    <% } else { %>
                                                                                        <% if (canShowTracking &&
                                                                                            trackingCodes.length> 0) {
                                                                                            %>
                                                                                            <%
                                                                                                trackingCodes.forEach(code=>
                                                                                                { %>
                                                                                                <div
                                                                                                    class="tracking-box">
                                                                                                    <p
                                                                                                        class="tracking-title">
                                                                                                        üöö
                                                                                                        ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:
                                                                                                    </p>
                                                                                                    <a href="https://track.thailandpost.co.th/?trackNumber=<%= code %>"
                                                                                                        target="_blank"
                                                                                                        class="tracking-link">
                                                                                                        <%= code %>
                                                                                                    </a>
                                                                                                    <button
                                                                                                        type="button"
                                                                                                        class="btn-track"
                                                                                                        data-tracking="<%= code %>">
                                                                                                        ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á
                                                                                                    </button>
                                                                                                    <div class="shipping-detail"
                                                                                                        style="display:none;">
                                                                                                    </div>
                                                                                                </div>
                                                                                                <% }) %>
                                                                                                    <% } else { %>
                                                                                                        <p
                                                                                                            style="color:#888;">
                                                                                                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
                                                                                                        </p>
                                                                                                        <% } %>
                                                                                                            <% } %>
                                                                </div>


                                        </div>
                                    </article>
                                    <% }) %>
                                        <% } %>
                </section>
            </main>

            <%- include('includes/footer') %>

                <!-- ‚úÖ Popup ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
                <div id="receive-popup" class="popup" style="display:none;">
                    <div class="popup-content">
                        <h3>üì∏ ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                        <input type="file" id="receive-images" multiple accept="image/*">
                        <div id="preview-area"></div>
                        <div class="popup-actions">
                            <button id="confirm-receive" class="btn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                            <button id="cancel-popup" class="btn gray">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ Popup ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
                <div id="return-popup" class="popup" style="display:none;">
                    <div class="popup-content">
                        <h3>üì¶ ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>

                        <form id="returnForm" enctype="multipart/form-data">
                            <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏:</label>
                            <input type="text" id="return-tracking" name="tracking_code"
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô EX123456789TH" required>

                            <label>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à / ‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏:</label>
                            <input type="file" id="return-image" name="receipt" accept="image/*" required>

                            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ:</label>
                            <div id="return-items" class="item-list">
                                <% activeRentals .filter(r=> r.rental_status === "RENTED")
                                    .forEach(r => { %>
                                    <div class="item-option">
                                        <input type="checkbox" name="rental_ids" value="<%= r.rental_id %>">
                                        <img src="<%= r.product?.images?.[0]?.image_url || '/images/no-image.png' %>"
                                            width="60">
                                        <span>
                                            <%= r.product.product_name %>
                                        </span>
                                    </div>
                                    <% }) %>
                            </div>

                            <div class="popup-actions">
                                <button type="submit" class="btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                                <button type="button" id="cancel-return" class="btn gray">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            </div>
                        </form>
                    </div>
                </div>

                <script src="/js/script.js"></script>

                <script>
                    document.addEventListener("DOMContentLoaded", () => {
                        // ‚úÖ ‡∏ß‡∏≤‡∏î timeline
                        function paintTimeline(step, label) {
                            document.querySelectorAll('.step').forEach(s => s.classList.remove('done'));
                            document.querySelectorAll('.line').forEach(l => l.classList.remove('completed'));
                            for (let i = 1; i <= step; i++) {
                                document.querySelector(`.step:nth-of-type(${i * 2 - 1})`)?.classList.add('done');
                                document.querySelector(`.line:nth-of-type(${i * 2})`)?.classList.add('completed');
                            }
                            document.getElementById('tracking-label').textContent = `üì¶ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${label}`;
                        }

                        // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å API
                        async function loadForRental(rentalId) {
                            try {
                                const res = await fetch(`/api/tracking/timeline?rental_id=${rentalId}`);
                                const data = await res.json();
                                if (res.ok) {
                                    paintTimeline(data.step || 1, data.label || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...');
                                } else {
                                    document.getElementById('tracking-label').textContent = data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
                                }
                            } catch {
                                document.getElementById('tracking-label').textContent = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
                            }
                        }

                        // ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î timeline
                        document.querySelectorAll('.item-card').forEach(card => {
                            const id = card.dataset.rental;
                            card.addEventListener('click', () => {
                                document.querySelectorAll('.item-card').forEach(c => c.classList.remove('active'));
                                card.classList.add('active');
                                loadForRental(id);
                            });
                        });

                        // ‚úÖ ‡∏ú‡∏π‡∏Å event ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á‚Äù
                        document.querySelectorAll('.btn-track').forEach(btn => {
                            btn.addEventListener('click', async () => {
                                const tracking = btn.dataset.tracking;
                                const container = btn.nextElementSibling;

                                if (container.style.display === 'block') {
                                    container.style.display = 'none';
                                    return;
                                }

                                document.querySelectorAll('.shipping-detail').forEach(div => div.style.display = 'none');
                                container.style.display = 'block';
                                container.innerHTML = '<p>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏±‡∏™‡∏î‡∏∏...</p>';

                                try {
                                    const res = await fetch(`/api/tracking/detail?tracking_code=${tracking}`);
                                    const data = await res.json();
                                    if (!res.ok) throw new Error(data.message);

                                    const html = data.tracks.map(item => `
              <div class="track-item">
                <p><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${item.status}</p>
                <p><b>‡πÄ‡∏ß‡∏•‡∏≤:</b> ${item.date}</p>
                <p><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</b> ${item.location}</p>
                <p><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${item.detail}</p>
                <hr>
              </div>
            `).join('');

                                    container.innerHTML = `
              <div class="shipping-timeline">
                <h4>üì¶ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå‡πÑ‡∏ó‡∏¢</h4>
                ${html}
              </div>
            `;
                                } catch (err) {
                                    container.innerHTML = `<p style="color:red;">‚ö†Ô∏è ${err.message}</p>`;
                                }
                            });
                        });

                        // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡πÅ‡∏£‡∏Å
                        const first = document.querySelector('.item-card');
                        if (first) first.click();
                    });
                    // ============================
                    // üì¶ ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    // ============================
                    let currentRentalId = null;
                    const popup = document.getElementById('receive-popup');
                    const input = document.getElementById('receive-images');
                    const preview = document.getElementById('preview-area');

                    document.querySelectorAll('.btn-receive').forEach(btn => {
                        btn.addEventListener('click', () => {
                            if (btn.disabled) return;
                            currentRentalId = btn.dataset.rental;
                            popup.style.display = 'flex';
                        });
                    });

                    document.getElementById('cancel-popup').onclick = () => {
                        popup.style.display = 'none';
                        input.value = '';
                        preview.innerHTML = '';
                    };

                    // ‡πÅ‡∏™‡∏î‡∏á preview ‡∏£‡∏π‡∏õ
                    input.addEventListener('change', e => {
                        preview.innerHTML = '';
                        Array.from(e.target.files).forEach(file => {
                            const img = document.createElement('img');
                            img.src = URL.createObjectURL(file);
                            preview.appendChild(img);
                        });
                    });

                    // ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                    document.getElementById('confirm-receive').onclick = async () => {
                        if (!currentRentalId) return;
                        const formData = new FormData();
                        formData.append('rental_id', currentRentalId);
                        Array.from(input.files).forEach(f => formData.append('images', f));

                        const res = await fetch('/api/confirm-receive', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await res.json();
                        if (res.ok) {
                            alert('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ');
                            location.reload();
                        } else {
                            alert('‚ùå ' + (data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
                        }
                    };

                    // ============================
                    // üì¶ Popup ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    // ============================
                    const returnPopup = document.getElementById("return-popup");
                    const cancelReturn = document.getElementById("cancel-return");
                    const returnForm = document.getElementById("returnForm");

                    document.querySelectorAll('.btn-return').forEach(btn => {
                        btn.addEventListener('click', () => {
                            returnPopup.style.display = 'flex';
                            returnForm.dataset.order = btn.dataset.order;
                        });
                    });

                    cancelReturn.addEventListener('click', () => {
                        returnPopup.style.display = 'none';
                        returnForm.reset();
                    });

                    returnForm.addEventListener('submit', async e => {
                        e.preventDefault();

                        const orderId = returnForm.dataset.order;
                        const trackingCode = document.getElementById('return-tracking').value.trim();
                        const imageFile = document.getElementById('return-image').files[0];
                        const selected = [...document.querySelectorAll("input[name='rental_ids']:checked")].map(el => el.value);

                        if (!selected.length) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô");
                        if (!trackingCode) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏");

                        const formData = new FormData();
                        formData.append('order_id', orderId);
                        formData.append('tracking_code', trackingCode);
                        selected.forEach(id => formData.append('rental_ids[]', id));
                        formData.append('receipt', imageFile);

                        const res = await fetch('/api/return-box', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await res.json();

                        if (res.ok) {
                            alert('üì¶ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                            location.reload();
                        } else {
                            alert('‚ùå ' + (data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
                        }
                    });

                </script>

    </body>

    </html>