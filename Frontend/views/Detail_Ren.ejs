<%- include('includes/head') %>
<link rel="stylesheet" href="/styles/rental.css">
<link rel="stylesheet" href="/styles/detailRen.css">
</head>

<body>
  <%- include('includes/nav') %>

  <main>
    <section class="index">
      <h2>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤</h2>

      <!-- ‚úÖ Timeline ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
      <div class="timeline-horizontal">
        <div class="step"><div class="circle">1</div><p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p></div>
        <div class="line"></div>
        <div class="step"><div class="circle">2</div><p>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á</p></div>
        <div class="line"></div>
        <div class="step"><div class="circle">3</div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</p></div>
        <div class="line"></div>
        <div class="step"><div class="circle">4</div><p>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p></div>
        <div class="line"></div>
        <div class="step"><div class="circle">5</div><p>‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</p></div>
        <div class="line"></div>
        <div class="step"><div class="circle">6</div><p>‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô)</p></div>
        <div class="line"></div>
        <div class="step"><div class="circle">7</div><p>‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p></div>
      </div>

      <p id="tracking-label" class="tracking-note">üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p>

      <!-- ‚úÖ ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ -->
      <div class="order-summary">
        <h3>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: <%= order.order_code %></h3>
        <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á: <%= new Date(order.created_at).toLocaleDateString("th-TH") %></p>
      </div>

      <!-- ‚úÖ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ -->
      <% 
        const activeRentals = order.Rentals.filter(r =>
          ["WAITING_CONFIRM","WAITING_DELIVER","WAITING_RECEIVE","RENTED","RETURNING","RETURNED"].includes(r.rental_status)
        );
      %>

      <% if (activeRentals.length === 0) { %>
        <p style="text-align:center; color:#777;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤</p>
      <% } else { %>
        <% activeRentals.forEach(r => { %>
          <article class="rental-card item-card" data-rental="<%= r.rental_id %>">
            <img src="<%= r.product?.images?.[0]?.image_url || '/images/no-image.png' %>"
                 alt="" class="thumb">

            <div class="meta">
              <h4><%= r.product?.product_name %></h4>
              <p>
                ‡πÄ‡∏ä‡πà‡∏≤: <%= new Date(r.rental_date).toLocaleDateString('th-TH') %> ‚Ä¢
                ‡∏Ñ‡∏∑‡∏ô: <%= new Date(r.rental_end_date).toLocaleDateString('th-TH') %>
              </p>

              <p class="status <%= r.rental_status.toLowerCase().replace('_','-') %>">
                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:
                <% if (r.rental_status === "WAITING_CONFIRM") { %>
                  ‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô
                <% } else if (r.rental_status === "WAITING_DELIVER") { %>
                  ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á
                <% } else if (r.rental_status === "WAITING_RECEIVE") { %>
                  ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
                <% } else if (r.rental_status === "RENTED") { %>
                  ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                <% } else if (r.rental_status === "RETURNING") { %>
                  ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                <% } else if (r.rental_status === "RETURNED") { %>
                  ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                <% } %>
              </p>

              <%
              // ‚úÖ ‡πÉ‡∏ä‡πâ order.shippings ‡πÅ‡∏ó‡∏ô r.order ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ö‡∏ô‡∏™‡∏∏‡∏î
              const boxes = order.shippings.flatMap(s => s.boxes)
                .filter(b => b.items?.some(it =>
                  it.orderItem?.product?.product_id === r.product.product_id &&
                  (!r.orderItemId || it.orderItemId === r.orderItemId)
                ));
            
              const trackingCodes = boxes.map(b => b.tracking_code).filter(Boolean);
              const canShowTracking = ["WAITING_RECEIVE", "RENTED", "RETURNING", "RETURNED"].includes(r.rental_status);
            %>
            

              <div class="tracking-section">
                <p>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏:</p>
                <% if (canShowTracking && trackingCodes.length > 0) { %>
                  <% trackingCodes.forEach(code => { %>
                    <div class="tracking-box">
                      <a href="https://track.thailandpost.co.th/?trackNumber=<%= code %>"
                         target="_blank" class="tracking-link"><%= code %></a>
                      <button type="button" class="btn-track" data-tracking="<%= code %>">
                        ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á
                      </button>
                      <div class="shipping-detail" style="display:none;"></div>
                    </div>
                  <% }) %>
                <% } else { %>
                  <span style="color:#888;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</span>
                <% } %>
              </div>
            </div>
          </article>
        <% }) %>
      <% } %>
    </section>
  </main>

  <%- include('includes/footer') %>
  <script src="/js/script.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ‚úÖ ‡∏ß‡∏≤‡∏î timeline
      function paintTimeline(step, label) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('done'));
        document.querySelectorAll('.line').forEach(l => l.classList.remove('completed'));
        for (let i = 1; i <= step; i++) {
          document.querySelector(`.step:nth-of-type(${i * 2 - 1})`)?.classList.add('done');
          document.querySelector(`.line:nth-of-type(${i * 2})`)?.classList.add('completed');
        }
        document.getElementById('tracking-label').textContent = `üì¶ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${label}`;
      }

      // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å API
      async function loadForRental(rentalId) {
        try {
          const res = await fetch(`/api/tracking/timeline?rental_id=${rentalId}`);
          const data = await res.json();
          if (res.ok) {
            paintTimeline(data.step || 1, data.label || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...');
          } else {
            document.getElementById('tracking-label').textContent = data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
          }
        } catch {
          document.getElementById('tracking-label').textContent = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
        }
      }

      // ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î timeline
      document.querySelectorAll('.item-card').forEach(card => {
        const id = card.dataset.rental;
        card.addEventListener('click', () => {
          document.querySelectorAll('.item-card').forEach(c => c.classList.remove('active'));
          card.classList.add('active');
          loadForRental(id);
        });
      });

      // ‚úÖ ‡∏ú‡∏π‡∏Å event ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á‚Äù
      document.querySelectorAll('.btn-track').forEach(btn => {
        btn.addEventListener('click', async () => {
          const tracking = btn.dataset.tracking;
          const container = btn.nextElementSibling;

          if (container.style.display === 'block') {
            container.style.display = 'none';
            return;
          }

          document.querySelectorAll('.shipping-detail').forEach(div => div.style.display = 'none');
          container.style.display = 'block';
          container.innerHTML = '<p>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏±‡∏™‡∏î‡∏∏...</p>';

          try {
            const res = await fetch(`/api/tracking/detail?tracking_code=${tracking}`);
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);

            const html = data.tracks.map(item => `
              <div class="track-item">
                <p><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${item.status}</p>
                <p><b>‡πÄ‡∏ß‡∏•‡∏≤:</b> ${item.date}</p>
                <p><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</b> ${item.location}</p>
                <p><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${item.detail}</p>
                <hr>
              </div>
            `).join('');

            container.innerHTML = `
              <div class="shipping-timeline">
                <h4>üì¶ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå‡πÑ‡∏ó‡∏¢</h4>
                ${html}
              </div>
            `;
          } catch (err) {
            container.innerHTML = `<p style="color:red;">‚ö†Ô∏è ${err.message}</p>`;
          }
        });
      });

      // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡πÅ‡∏£‡∏Å
      const first = document.querySelector('.item-card');
      if (first) first.click();
    });
  </script>
</body>
</html>
