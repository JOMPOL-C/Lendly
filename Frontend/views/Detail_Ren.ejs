<%- include('includes/head') %>
<link rel="stylesheet" href="/styles/rental.css">
</head>

<body>
  <%- include('includes/nav') %>

  <main>
    <section class="index">
      <h2>ติดตามสถานะการเช่า</h2>

      <div class="rental-info">
        <p>ที่อยู่ในการจัดส่ง: โชยุ โชใจ 123/45 หมู่บ้านสุขสันต์ ต.สุขใจ อ.เมือง จ.เชียงใหม่ 50000</p>
        <p>หมายเลขการเช่า: RNT-0001</p>
        <p>ระยะเวลา: 01/10/2025 - 07/10/2025</p>
      </div>

      <!-- Timeline เดิม -->
      <div class="timeline-horizontal">
        <div class="step done">
          <div class="circle">1</div>
          <p>สร้างคำสั่งเช่า<br><span>2025-09-25</span></p>
        </div>
        <div class="line"></div>
        <div class="step done">
          <div class="circle">2</div>
          <p>ชำระเงิน<br><span>2025-09-25</span></p>
        </div>
        <div class="line"></div>
        <div class="step done">
          <div class="circle">3</div>
          <p>เตรียมสินค้า<br><span>2025-09-26</span></p>
        </div>
        <div class="line"></div>
        <div class="step done">
          <div class="circle">4</div>
          <p>จัดส่ง<br><span>2025-09-27</span></p>
        </div>
        <div class="line"></div>
        <div class="step">
          <div class="circle">5</div>
          <p>ใช้งานอยู่</p>
        </div>
        <div class="line"></div>
        <div class="step">
          <div class="circle">6</div>
          <p>คืนสินค้า</p>
        </div>
        <div class="line"></div>
        <div class="step">
          <div class="circle">7</div>
          <p>รีวิว</p>
        </div>
      </div>

      <div id="tracking-container" class="tracking-status"></div>

      <div style="text-align:center; margin-top:20px;">
        <a href="/return_order" class="btn">คืนสินค้า</a>
        <a href="/write_review" class="btn">รีวิวสินค้า</a>
      </div>
    </section>
  </main>

  <%- include('includes/footer') %>
  <script src="/js/script.js"></script>

  <script>
    const params = new URLSearchParams(window.location.search);
    const rentalId = params.get("rental_id");
    const container = document.getElementById("tracking-container");

    async function loadTracking() {
      try {
        const res = await fetch(`/api/tracking?rental_id=${rentalId}`);
        const data = await res.json();

        if (data.message) {
          container.innerHTML = `<p>${data.message}</p>`;
          return;
        }

        // สร้างบล็อกสถานะ
        Object.entries(data).forEach(([code, events]) => {
          const block = document.createElement("div");
          block.style.marginTop = "15px";
          block.innerHTML = `<h4>เลขพัสดุ: ${code}</h4>`;

          events.forEach(ev => {
            const line = document.createElement("p");
            line.textContent = `${new Date(ev.status_date).toLocaleString("th-TH")} — ${ev.status_description}`;
            block.appendChild(line);
          });

          container.appendChild(block);
        });
      } catch (err) {
        container.innerHTML = `<p style="color:red;">ไม่สามารถโหลดข้อมูลการจัดส่งได้</p>`;
        console.error("❌ tracking error:", err);
      }
    }

    loadTracking();
  </script>
</body>
</html>
