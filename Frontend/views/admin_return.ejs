<%- include('includes/head') %>
<link rel="stylesheet" href="/styles/admin.css">
<link rel="stylesheet" href="/styles/adminReturn.css">
</head>
<body>
  <%- include('includes/navAdmin') %>

  <main class="admin-page">
    <h2>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô</h2>

    <!-- üü£ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô -->
    <div class="summary-box">
      <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ:</p>
      <h3 id="return-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
    </div>

    <table class="admin-table">
      <thead>
        <tr>
          <th>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡πà‡∏≤</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
          <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="returning-list"></tbody>
    </table>
  </main>

  <script>
    async function loadReturning() {
      const res = await fetch('/api/rentals');
      const data = await res.json();
      const tbody = document.getElementById('returning-list');
      const countBox = document.getElementById('return-count');
      tbody.innerHTML = '';

      const returning = data.filter(r => r.rental_status === 'RETURNING');
      countBox.textContent = `${returning.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

      returning.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.rental_id}</td>
          <td>${r.product.product_name}</td>
          <td>${r.customer?.name || '-'}</td>
          <td>${r.rental_status}</td>
          <td>
            <button onclick="markReturned(${r.rental_id})">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function markReturned(id) {
      const confirmed = confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?');
      if (!confirmed) return;

      const res = await fetch(`/api/rentals/${id}/return`, { method: 'PUT' });
      const data = await res.json();
      alert(data.message || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß');
      loadReturning();
    }

    loadReturning();
  </script>
</body>
</html>
