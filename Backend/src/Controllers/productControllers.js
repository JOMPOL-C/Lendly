const prisma = require('../../prisma/prisma');
const multer = require('multer');
const cloudinary = require('cloudinary').v2;

// memory storage (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á disk)
const storage = multer.memoryStorage();
exports.upload = multer({ storage }).array("product_images", 10); // ‡∏≠‡∏±‡∏õ‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏£‡∏π‡∏õ

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á buffer ‚Üí data URI
const bufferToDataUri = (file) =>
    `data:${file.mimetype};base64,${file.buffer.toString('base64')}`;

// POST /api/products ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
exports.createProduct = async (req, res) => {
    try {
      const {
        product_name,
        story_name,
        shipping_info,
        categoryId,
        chest,
        waist,
        hips,
        price_costume,
        price_wig,
        price_suit_wig,
        price_prop,
        price_shoe,
        price_pry_extra,
        price_prop_addon,
        price_shoe_addon,
        days_suit_test,
        days_suit_pri
      } = req.body;
  
      const files = req.files || [];
      console.log("üì¶ req.body:", req.body);
  
      // ‚úÖ helper ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô NaN
      const toNum = v => (v && !isNaN(parseFloat(v)) ? parseFloat(v) : 0);
  
      // ‚úÖ 1) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏∂‡πâ‡∏ô Cloudinary
      const uploadPromises = files.map(file =>
        cloudinary.uploader.upload(bufferToDataUri(file), { folder: "lendly_products" })
      );
      const uploadResults = await Promise.all(uploadPromises);
  
      // ‚úÖ 2) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      const proportion = await prisma.Proportion_product.create({
        data: {
          chest: toNum(chest),
          waist: toNum(waist),
          hips: toNum(hips)
        }
      });
  
      // ‚úÖ 3) ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      const suit = toNum(price_costume);
      const wig = toNum(price_wig);
      const suitWig = toNum(price_suit_wig); // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Ç‡∏≠‡∏á‡∏ä‡∏∏‡∏î+‡∏ß‡∏¥‡∏Å
      const prop = toNum(price_prop);
      const shoe = toNum(price_shoe);
      const addonProp = toNum(price_prop_addon);
      const addonShoe = toNum(price_shoe_addon);
      const pryExtra = toNum(price_pry_extra);
  
      const testDays = days_suit_test ? parseInt(days_suit_test) : null;
      const priDays = days_suit_pri ? parseInt(days_suit_pri) : null;
  
      const priceData = [];
  
      // üß• ‡∏ä‡∏∏‡∏î
      if (suit > 0) {
        priceData.push({
          type: "suit",
          price_test: suit,
          price_pri: suit + pryExtra,
          days_test: testDays,
          days_pri: priDays
        });
      }
  
      // üíá ‡∏ß‡∏¥‡∏Å
      if (wig > 0) {
        priceData.push({
          type: "wig",
          price_test: wig,
          price_pri: wig + pryExtra,
          days_test: testDays,
          days_pri: priDays
        });
      }
  
      // üé≠ ‡∏û‡∏£‡πá‡∏≠‡∏û‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß
      if (prop > 0) {
        priceData.push({
          type: "solo_prop",
          price_test: prop,
          price_pri: prop + pryExtra,
          days_test: testDays,
          days_pri: priDays
        });
      }
  
      // üëü ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß
      if (shoe > 0) {
        priceData.push({
          type: "solo_shoe",
          price_test: shoe,
          price_pri: shoe + pryExtra,
          days_test: testDays,
          days_pri: priDays
        });
      }
  
      // üí° ‡∏û‡∏£‡πá‡∏≠‡∏û‡πÄ‡∏™‡∏£‡∏¥‡∏°
      if (addonProp > 0) {
        priceData.push({
          type: "addon_prop",
          price_test: addonProp,
          price_pri: addonProp + pryExtra,
          days_test: testDays,
          days_pri: priDays
        });
      }
  
      // üí° ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏™‡∏£‡∏¥‡∏°
      if (addonShoe > 0) {
        priceData.push({
          type: "addon_shoe",
          price_test: addonShoe,
          price_pri: addonShoe + pryExtra,
          days_test: testDays,
          days_pri: priDays
        });
      }
  
      // üëóüíá ‡∏ä‡∏∏‡∏î + ‡∏ß‡∏¥‡∏Å (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©)
      if (suitWig > 0) {
        priceData.push({
          type: "suit_wig",
          price_test: suitWig,
          price_pri: suitWig + pryExtra,
          days_test: testDays,
          days_pri: priDays
        });
  
        // ‚úÖ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ suit_wig ‡∏î‡πâ‡∏ß‡∏¢
        if (addonProp > 0) {
          priceData.push({
            type: "suit_wig_prop",
            price_test: suitWig + addonProp,
            price_pri: suitWig + addonProp + pryExtra,
            days_test: testDays,
            days_pri: priDays
          });
        }
  
        if (addonShoe > 0) {
          priceData.push({
            type: "suit_wig_shoe",
            price_test: suitWig + addonShoe,
            price_pri: suitWig + addonShoe + pryExtra,
            days_test: testDays,
            days_pri: priDays
          });
        }
  
        if (addonProp > 0 && addonShoe > 0) {
          priceData.push({
            type: "suit_wig_prop_shoe",
            price_test: suitWig + addonProp + addonShoe,
            price_pri: suitWig + addonProp + addonShoe + pryExtra,
            days_test: testDays,
            days_pri: priDays
          });
        }
      }
  
      // ‚ùó ‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏±‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      if (priceData.length === 0) {
        return res.status(400).send("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
      }
  
      // ‚úÖ 4) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      await prisma.Product.create({
        data: {
          product_name,
          story_name,
          shipping_info,
          category: { connect: { category_id: categoryId } },
          size: { connect: { proportion_product_id: proportion.proportion_product_id } },
          prices: { create: priceData },
          images: {
            create: uploadResults.map(r => ({
              image_url: r.secure_url,
              cloudinary_id: r.public_id
            }))
          }
        }
      });
  
      res.redirect("/");
    } catch (err) {
      console.error("‚ùå Error createProduct:", err);
      res.status(500).send("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }
  };
  
// PUT /api/products/:id/update ‚Üí ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
exports.updateProduct = async (req, res) => {
    try {
        const { id } = req.params;
        const {
            product_name,
            story_name,
            shipping_info,
            categoryId,
            chest,
            waist,
            hips,
            price_costume,
            price_wig,
            price_prop,
            price_shoe,
            price_pry_extra,
            price_shoe_extra,
            days_suit_test,
            days_suit_pri
        } = req.body;

        const files = req.files || [];

        const product = await prisma.Product.findUnique({
            where: { product_id: parseInt(id) },
            include: { images: true }
        });

        if (!product) return res.status(404).send("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");

        // ‚úÖ ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Cloudinary
        for (const img of product.images) {
            await cloudinary.uploader.destroy(img.cloudinary_id);
        }

        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô Cloudinary
        const uploadPromises = files.map(file =>
            cloudinary.uploader.upload(bufferToDataUri(file), {
                folder: "lendly_products",
            })
        );
        const uploadResults = await Promise.all(uploadPromises);

        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô
        await prisma.Proportion_product.update({
            where: { proportion_product_id: product.ppId },
            data: {
                chest: chest ? parseFloat(chest) : null,
                waist: waist ? parseFloat(waist) : null,
                hips: hips ? parseFloat(hips) : null
            }
        });

        // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà
        const priceData = [];
        // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ä‡∏∏‡∏î
        if (price_costume) {
            priceData.push({
                type: "suit",
                price_test: parseFloat(price_costume),
                price_pri: parseFloat(price_costume),
                days_test: days_suit_test ? parseInt(days_suit_test) : null,
                days_pri: days_suit_pri ? parseInt(days_suit_pri) : null
            });
        }

        // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ß‡∏¥‡∏Å
        if (price_wig) {
            priceData.push({
                type: "wig",
                price_test: parseFloat(price_wig),
                price_pri: parseFloat(price_wig)
            });
            if (price_costume) {
                priceData.push({
                    type: "suit_wig",
                    price_test: parseFloat(price_costume) + parseFloat(price_wig),
                    price_pri: parseFloat(price_costume) + parseFloat(price_wig)
                });
            }
        }

        // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏£‡πá‡∏≠‡∏û
        if (price_prop) {
            priceData.push({
                type: "solo_prop",
                price_test: parseFloat(price_prop),
                price_pri: parseFloat(price_prop)
            });
        }

        // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤
        if (price_shoe) {
            priceData.push({
                type: "solo_shoe",
                price_test: parseFloat(price_shoe),
                price_pri: parseFloat(price_shoe)
            });
        }

        if (price_pry_extra) {
            priceData.push({
                type: "addon_prop",
                price_test: parseFloat(price_pry_extra),
                price_pri: parseFloat(price_pry_extra)
            });
        }
        if (price_shoe_extra) {
            priceData.push({
                type: "addon_shoe",
                price_test: parseFloat(price_shoe_extra),
                price_pri: parseFloat(price_shoe_extra)
            });
        }

        // ‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Å‡πà‡∏≤ + ‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ô DB
        await prisma.Price.deleteMany({ where: { productId: parseInt(id) } });
        await prisma.ProductImage.deleteMany({ where: { productId: parseInt(id) } });

        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        await prisma.Product.update({
            where: { product_id: parseInt(id) },
            data: {
                product_name,
                story_name,
                shipping_info,
                categoryId: parseInt(categoryId),
                prices: { create: priceData },
                images: {
                    create: uploadResults.map(r => ({
                        image_url: r.secure_url,
                        cloudinary_id: r.public_id
                    }))
                }
            }
        });

        res.redirect("/");
    } catch (err) {
        console.error("Error updateProduct:", err);
        res.status(500).send("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }
};


// GET /products/add ‚Üí ‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
exports.renderAddProduct = async (req, res) => {
    try {
        const categories = await prisma.Category.findMany();
        res.render("add_pro", { categories });
    } catch (err) {
        console.error("Error renderAddProduct:", err);
        res.status(500).send("‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }
};


// GET /products/:id ‚Üí ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
exports.getProductById = async (req, res) => {
    try {
        const { id } = req.params;
        const product = await prisma.Product.findUnique({
            where: { product_id: parseInt(id) },
            include: {
                images: true,
                prices: true,
                category: true
            }
        });

        if (!product) {
            return res.status(404).send("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
        }

        res.render("Detail_Pro", { product });
    } catch (err) {
        console.error("Error getProductById:", err);
        res.status(500).send("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }
};


// GET /products/:id/edit ‚Üí render ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
exports.renderEditProduct = async (req, res) => {
    try {
        const { id } = req.params;

        const product = await prisma.Product.findUnique({
            where: { product_id: parseInt(id, 10) },
            include: {
                prices: true,
                proportion: true   // üëà ‡∏î‡∏∂‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            }
        });

        if (!product) return res.status(404).send("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");

        const categories = await prisma.Category.findMany();

        res.render("edit_pro", { product, categories });
    } catch (err) {
        console.error("Error renderEditProduct:", err);
        res.status(500).send("‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }
};

// GET / ‚Üí ‡∏´‡∏ô‡πâ‡∏≤ home ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
exports.getProducts = async (req, res) => {
    try {
        const products = await prisma.Product.findMany({
            include: {
                images: true,
                prices: true
            },
            orderBy: { product_id: "desc" }
        });

        res.render("home", { products });
    } catch (err) {
        console.error("Error getProducts:", err);
        res.status(500).send("‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
    }
};

// GET ‡πÇ‡∏ä‡∏ß‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ category
exports.renderProductsPage = async (req, res) => {
    try {
        const categories = await prisma.category.findMany({
            orderBy: { category_name: 'asc' }
        });

        const products = await prisma.product.findMany({
            include: { images: true, prices: true, category: true },
            orderBy: { product_id: 'desc' }
        });

        res.render("category", { categories, products }); // ‚úÖ ‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà
    } catch (err) {
        console.error("Error renderProductsPage:", err);
        res.status(500).send("‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
    }
};
